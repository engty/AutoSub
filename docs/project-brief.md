# Project Brief: Clash AutoSub

**版本：** 1.0
**创建日期：** 2025-10-01
**最后更新：** 2025-10-01
**项目状态：** 规划阶段

---

## Executive Summary（执行摘要）

**Clash AutoSub** 是一个 Python 命令行自动化工具，专为需要频繁更新 VPN 订阅地址的用户设计。该工具通过自动登录指定的 VPN 代理网站、抓取最新订阅地址并更新到 ClashX 配置文件，解决了订阅地址每 5 分钟更新一次导致的手动维护负担。

**主要问题：** 部分 VPN 代理网站采用高频更新机制（5 分钟/次），用户需要频繁手动登录网站获取新订阅地址并更新 ClashX 配置，过程繁琐且容易中断网络连接。

**目标用户：** 使用 ClashX 的 macOS、Linux 和 Windows（通过 WSL）用户，特别是依赖频繁更新订阅地址的 VPN 服务的技术用户。

**核心价值：**
- **自动化流程：** 通过一键命令或定时任务自动化订阅更新，消除手动操作
- **安全优先：** 远程脚本配置，用户配置文件仅保存在本地，不上传任何敏感信息
- **持续可用：** 确保 VPN 连接持续可用，无需人工干预

---

## Problem Statement（问题陈述）

### 当前状态

部分 VPN 代理服务提供商（如"红杏云"、"糖果云"等机场）为了安全性和负载均衡，采用了**动态订阅地址机制**，订阅 URL 每 5 分钟自动更新一次。用户需要频繁执行以下流程：

1. 访问 VPN 服务商网站（如 https://candytally.xyz）
2. 手动登录账户
3. 在用户面板中找到并复制最新的订阅地址
4. 打开 ClashX 配置文件，更新 `proxy-providers` 中对应的 `url` 字段
5. 保存文件并重启 ClashX 服务

### 核心痛点

#### 1. 订阅地址获取的技术难点（⭐ 核心挑战）
- **自动登录复杂性：** 需要模拟浏览器行为，处理登录表单、验证码（如有）、会话管理
- **页面结构识别：** 订阅地址在登录后的用户面板中，需要准确定位 DOM 元素
- **动态页面加载：** 现代 Web 应用使用 JavaScript 渲染，需要等待页面完全加载
- **网站结构变化：** VPN 网站可能随时调整页面布局，导致元素选择器失效

#### 2. 高频繁操作负担
- 5 分钟更新机制导致订阅地址频繁失效
- 用户需要持续关注并手动登录、复制、更新
- 多个 VPN 账户需要分别管理

#### 3. 连接中断风险
- 订阅地址过期后，VPN 连接自动断开
- 影响正在进行的工作任务

#### 4. 多账户管理复杂
- 需要分别管理多个机场的用户名、密码
- 每个机场的登录流程和订阅获取方式可能不同

#### 5. 维护性问题（⭐ 项目设计重点）
- VPN 网站页面结构可能随时变化
- 需要通过 **GitHub 远程脚本** 快速推送更新，无需用户手动修改代码
- YAML 配置文件更新相对简单，但自动登录和抓取是关键难点

### 现有解决方案的不足

- **ClashX 内置更新：** 不支持动态订阅地址和自动登录
- **手动脚本：** 页面变化时需要手动修改代码，维护困难
- **第三方工具：** 存在隐私泄露风险，用户凭证上传云端

### 技术约束

- **测试目标站点：** https://candytally.xyz/web/#/login（糖果云）
- **核心技术难点：** 自动登录 + 准确提取订阅链接
- **次要任务：** YAML 配置文件更新（相对容易）

### 问题的紧迫性和重要性

- **个人效率影响：** 频繁手动更新配置严重干扰工作流程，降低生产力
- **自动化需求：** 需要一个可靠的自动化解决方案，消除重复劳动
- **安全性要求：** 必须确保用户凭证和配置文件的本地化存储，不上传任何敏感信息
- **可维护性：** 通过 GitHub 远程脚本方式，确保页面变化时能快速适配更新

---

## Proposed Solution（解决方案）

### 核心概念

Clash AutoSub 是一个基于 **Python + Playwright** 的命令行自动化工具，通过 **GitHub 托管的远程安装脚本** 实现快速部署和更新。工具采用 **双登录策略** 和 **智能部分更新机制**，确保安全性和可靠性。

### 核心特性

#### 1. 双登录策略（⭐ 创新设计）

用户可根据 VPN 网站特性选择最适合的登录方式：

**策略 A：用户名密码登录**
- 适用场景：网站无验证码或验证码简单
- 优势：长期免维护，完全自动化
- 实现：Playwright 自动填写表单并提交

**策略 B：Cookie 会话登录**（⭐ 智能方案）
- 适用场景：网站有复杂验证码或多因素认证
- 优势：绕过验证码限制，短期内有效
- 实现流程：
  1. 脚本调用系统浏览器打开登录页面
  2. 用户手动完成登录（处理验证码/2FA）
  3. 脚本自动检测登录成功（监听特定 URL 变化或 DOM 元素）
  4. 自动提取并保存 Cookie 到本地加密文件
  5. 后续使用时直接加载 Cookie，跳过登录流程
- 有效期：根据网站策略，通常 7-30 天

#### 2. 智能部分更新机制（⭐ 可靠性保证）

**核心原则：成功的更新，失败的保留原配置**

- 逐个账户获取订阅地址
- 通过 HTTP 请求验证订阅地址有效性（状态码 + 内容格式）
- 成功的账户：更新订阅地址
- 失败的账户：保留原配置不变
- 自动备份原配置文件
- 支持一键回滚

#### 3. 技术架构

**自动登录与订阅抓取模块：**
- 使用 Playwright 模拟浏览器
- 支持 Headless 模式运行
- 智能等待页面加载完成
- 精确定位订阅链接元素
- 错误处理与重试机制

**配置管理模块：**
- 本地配置文件：`~/.autosub/config.yaml`
- 凭证本地加密存储
- 页面选择器可远程更新

**YAML 更新模块：**
- 精确定位 `proxy-providers` 部分
- 更新对应机场的 `url` 字段
- 保留其他配置不变
- 自动备份原文件

**远程维护模块：**
- GitHub 存储选择器配置文件
- 网站页面变化时仅需更新 GitHub 配置
- 用户运行脚本时自动拉取最新选择器
- 无需用户手动修改本地代码

**订阅地址验证模块：**
- 直接访问订阅地址检查 HTTP 状态码
- 验证内容格式（Clash YAML）
- 检查节点数量
- 确保订阅地址立即可用

#### 4. 核心差异化优势

✅ **隐私安全优先**
- 用户凭证仅保存在本地，使用加密存储
- GitHub 脚本仅包含页面选择器，不涉及用户数据
- 完全离线运行，无需上传任何信息

✅ **智能维护机制**
- 远程选择器配置文件，页面变化时快速适配
- 版本检查与自动更新提示
- 支持多机场的统一管理

✅ **用户体验优化**
- 向导式配置，降低使用门槛
- 一键更新命令，简单高效
- 详细的日志记录，便于调试

✅ **部分更新可靠性**
- 成功的更新，失败的保留
- 订阅地址自动验证
- 零配置损坏风险

#### 5. 工作流程

**首次使用（向导配置）：**
```bash
curl -fsSL https://raw.githubusercontent.com/xxx/Clash AutoSub/main/install.sh | bash
autosub setup
```

**日常更新（一键执行）：**
```bash
autosub update
```

**定时更新（Cron）：**
```bash
autosub cron  # 设置定时任务
```

**添加新机场：**
```bash
autosub setup  # 再次运行向导
```

#### 6. 为什么这个方案会成功

1. **解决核心痛点：** 自动化登录和订阅抓取，消除手动操作
2. **安全可靠：** 本地化存储，零隐私风险
3. **易于维护：** GitHub 远程选择器配置，快速适配网站变化
4. **技术成熟：** Python + Playwright 生态完善，稳定可靠
5. **扩展性强：** 支持多机场、多账户，可轻松添加新的 VPN 服务商

---

## Target Users（目标用户）

### Primary User Segment: 技术型 VPN 重度用户

**人群特征：**
- **技术背景：** 具备基础编程或命令行使用经验的开发者、IT从业者、技术爱好者
- **操作系统：** macOS、Linux 或 Windows（通过 WSL）用户
- **使用工具：** ClashX（macOS）、Clash for Windows、Clash Meta 等代理客户端
- **VPN 使用场景：**
  - 日常工作需要访问国际网络资源（GitHub, ChatGPT, Google 等）
  - 使用动态订阅地址的机场服务（如糖果云、红杏云等 5 分钟更新机制的服务商）
  - 管理多个 VPN 账户以确保网络稳定性

**当前行为与痛点：**
- 每天需要多次手动登录 VPN 网站更新订阅地址
- 频繁因订阅地址过期导致工作中断
- 手动复制粘贴订阅地址到 Clash 配置文件（`proxy-providers` 部分）
- 对隐私安全高度敏感，不信任第三方云端工具

**核心需求：**
1. **自动化需求：** 消除重复劳动，一键或定时更新订阅
2. **安全性需求：** 所有凭证本地存储，不上传云端
3. **可靠性需求：** 订阅地址自动验证，确保更新后立即可用
4. **灵活性需求：** 支持多账户管理，应对不同网站的验证机制

**使用目标：**
- 设置一次配置后，长期自动运行
- 通过 Cron/任务计划程序实现无人值守自动更新
- 减少 90% 以上的手动操作时间
- 确保 VPN 连接 24/7 持续可用

**技术能力：**
- **macOS/Linux 用户：** 能够使用终端运行 Shell 脚本，设置 Cron 定时任务
- **Windows 用户：** 了解 WSL 或 Git Bash，能够在类 Unix 环境下操作
- 理解基本的配置文件结构（YAML）
- 愿意尝试新的自动化工具

**平台分布：**
- macOS：40%（开发者主力平台）
- Windows：40%（通过 WSL 运行）
- Linux：20%（服务器/桌面用户）

### 非目标用户（明确排除）

❌ **企业用户/团队用户**
- 本项目定位为个人工具，不考虑企业级需求
- 不提供集中管理、权限控制等企业功能

❌ **完全不懂技术的小白用户**
- 本工具需要基本的命令行操作能力
- 不提供图形界面（GUI）
- 需要用户理解基本的配置文件概念

❌ **使用固定订阅地址的用户**
- 如果机场订阅地址长期不变，本工具无价值
- ClashX 内置更新功能已足够

---

## Goals & Success Metrics（目标与成功指标）

### Business Objectives（业务目标）

- **用户采用率：** 项目发布后 3 个月内获得 100+ GitHub Stars
- **活跃用户：** 月活跃用户（运行更新命令）达到 50+
- **社区反馈：** 获得 10+ 个有效 Issue 或 PR 贡献
- **稳定性：** 主要 VPN 网站（糖果云）适配成功率 > 95%

### User Success Metrics（用户成功指标）

- **时间节省：** 用户手动操作时间减少 90% 以上（从每天 10 分钟降至 1 分钟）
- **连接稳定性：** 订阅地址过期导致的连接中断减少 95%
- **配置成功率：** 用户首次安装配置成功率 > 80%
- **长期使用率：** 配置后持续使用 30 天以上的用户占比 > 60%

### Key Performance Indicators (KPIs)

- **安装成功率：** 用户执行安装脚本的成功率 > 90%
- **订阅更新成功率：** 单次更新操作成功获取订阅地址 > 85%
- **错误恢复率：** 更新失败时保留原配置，零配置损坏事故
- **平均响应时间：** 单个账户订阅更新耗时 < 30 秒
- **代码维护性：** 新增 VPN 网站支持时，选择器配置更新时间 < 1 小时

---

## MVP Scope（MVP 范围）

### Core Features (Must Have)（核心功能 - 必须有）

#### 1. VPN 站点配置向导
**功能描述：** 交互式向导引导用户完成 VPN 账户配置

**关键实现：**
- 自动化页面元素搜索（Playwright 智能定位订阅按钮）
- 验证订阅地址有效性
- 配置文件自动生成

**验收标准：**
- 用户仅需输入站点地址和凭证
- 自动识别订阅按钮并获取链接
- 配置保存到 `~/.autosub/config.yaml`

#### 2. 订阅地址更新（单次 + 定时）
**功能描述：** 支持手动和自动定时更新订阅地址

**2.1 单次更新：**
- 手动更新：一键执行，显示详细进度
- 部分失败时仅更新成功的账户

**2.2 定时更新（Cron 助手）：**
- 自动配置 Cron
- 提供日志查看
- 支持删除定时任务

**验收标准：**
- 手动更新：一键执行，显示详细进度
- 定时更新：自动配置 Cron，提供日志查看
- 部分失败时仅更新成功的账户

#### 3. ClashX 配置文件路径设置
**功能描述：** 向导引导用户指定 Clash 配置文件位置

**关键实现：**
- 自动检测常见 Clash 配置文件路径
- 支持手动指定路径
- 验证文件存在性和可写权限

**验收标准：**
- 自动检测 macOS/Linux/Windows 常见路径
- 支持自定义路径
- 验证路径有效性

#### 4. Clash AutoSub 脚本自动更新
**功能描述：** 检查并更新 Clash AutoSub 脚本到最新版本

**关键实现：**
- 检查 GitHub Releases 最新版本
- 下载并替换本地脚本
- 保留用户配置文件不变

**验收标准：**
- 自动检查版本更新
- 一键升级脚本
- 保留用户配置和数据

### Out of Scope for MVP（MVP 范围外）

以下功能**不包含**在 MVP 中，可作为后续版本迭代：

- ❌ 图形界面（GUI）
- ❌ 浏览器扩展
- ❌ 移动端支持
- ❌ 订阅地址加密存储
- ❌ 多设备同步
- ❌ 高级过滤规则
- ❌ 订阅地址转换
- ❌ 节点测速
- ❌ 通知推送
- ❌ Web 管理面板

### MVP Success Criteria（MVP 成功标准）

MVP 被认为成功需要满足：

1. **功能完整性：**
   - ✅ 用户能在 10 分钟内完成首次配置
   - ✅ 单次更新订阅地址成功率 > 85%
   - ✅ 支持至少 2 个主流 VPN 网站（糖果云、红杏云）

2. **稳定性：**
   - ✅ 更新失败时零配置损坏（智能部分更新）
   - ✅ Cookie 过期时提供清晰的重新登录提示
   - ✅ 自动备份配置文件

3. **易用性：**
   - ✅ 向导式配置流程，无需手动编辑配置文件
   - ✅ 一键更新命令
   - ✅ 详细的错误提示和日志

4. **可维护性：**
   - ✅ 新增 VPN 网站支持时，仅需更新 GitHub 选择器配置
   - ✅ 用户无需手动修改代码
   - ✅ 自动更新脚本功能

### MVP 核心命令总览

```bash
# 安装
curl -fsSL https://raw.githubusercontent.com/xxx/Clash AutoSub/main/install.sh | bash

# 配置向导（首次使用）
autosub setup          # 添加 VPN 账户
autosub config         # 设置 Clash 配置文件路径

# 日常使用
autosub update         # 手动更新订阅
autosub cron           # 设置定时更新

# 维护
autosub upgrade        # 更新 Clash AutoSub 脚本
autosub status         # 查看配置状态
autosub refresh-cookie <账户名>  # 刷新 Cookie

# 帮助
autosub --help         # 显示帮助信息
```

---

## Post-MVP Vision（后续版本规划）

### Phase 2 Features（第二阶段功能，3-6 个月后）

1. **智能订阅地址缓存机制**
2. **多种通知方式**（系统通知、邮件、Telegram Bot）
3. **高级日志与诊断**
4. **批量站点管理**
5. **订阅地址智能验证增强**

### Long-term Vision（长期愿景，1-2 年）

1. **生态系统扩展**
   - 浏览器扩展
   - Web 管理面板
   - 移动端支持

2. **智能化与自动化**
   - AI 页面元素识别
   - 智能订阅切换
   - 预测性维护

3. **社区驱动**
   - VPN 网站配置市场
   - 一键添加流行机场
   - 插件系统

### Expansion Opportunities（扩展机会）

- 支持其他代理工具（V2Ray, Shadowrocket, Surge）
- 支持订阅格式转换
- 与机场服务商合作

---

## Technical Considerations（技术考量）

### Platform Requirements（平台需求）

**目标平台：**
- macOS: 10.15+ (Catalina 及以上)
- Linux: Ubuntu 20.04+, Debian 11+, CentOS 8+, Arch Linux
- Windows: Windows 10/11 + WSL 2

**性能要求：**
- 内存: 最小 200 MB
- 磁盘空间: 约 300 MB
- 网络: 能够访问 VPN 网站

### Technology Preferences（技术偏好）

**前端（CLI）：**
- 语言: Bash（安装脚本） + Python 3.9+（核心逻辑）
- CLI 框架: `click` 或 `argparse`
- 交互式界面: `questionary` 或 `PyInquirer`

**后端（自动化引擎）：**
- 浏览器自动化: Playwright
- HTTP 客户端: `httpx`
- 配置解析: PyYAML
- 加密存储: `cryptography`

**数据存储：**
- 配置文件: YAML 格式
- Cookie 存储: JSON 格式
- 日志存储: 纯文本

**部署与分发：**
- 安装脚本: Shell Script
- 依赖管理: `requirements.txt` + `pip`
- 版本管理: GitHub Releases
- 自动更新: GitHub API

### Architecture Considerations（架构考量）

**Repository Structure（仓库结构）：**
```
Clash AutoSub/
├── install.sh                    # 安装脚本
├── autosub.py                    # 主程序入口
├── requirements.txt              # Python 依赖
├── README.md                     # 项目文档
├── LICENSE                       # 开源协议（MIT）
│
├── src/                          # 源代码目录
│   ├── __init__.py
│   ├── cli.py                    # 命令行接口
│   ├── config.py                 # 配置管理
│   ├── auth.py                   # 登录模块（密码/Cookie）
│   ├── scraper.py                # 订阅地址抓取
│   ├── validator.py              # 订阅地址验证
│   ├── updater.py                # Clash 配置更新
│   ├── cron.py                   # Cron 任务管理
│   └── utils.py                  # 工具函数
│
├── selectors/                    # 页面选择器配置
│   ├── selectors.json            # 主配置文件
│   └── sites/
│       ├── candytally.json       # 糖果云选择器
│       └── hongxingyun.json      # 红杏云选择器
│
├── tests/                        # 测试用例
└── docs/                         # 文档
```

**Security/Compliance（安全与合规）：**

- **数据安全：** 密码加密存储，Cookie 文件权限保护
- **网络安全：** HTTPS 强制，证书验证
- **隐私保护：** 本地化存储，无遥测
- **合规性：** MIT License，开源透明

---

## Constraints & Assumptions（约束与假设）

### Constraints（约束条件）

**预算约束：**
- 零预算，个人开源项目

**时间约束：**
- MVP 开发周期：2-3 周
- 迭代周期：每月一个小版本

**资源约束：**
- 单人开发
- 个人测试设备

**技术约束：**
- 需要访问 VPN 网站
- Python 3.9+ 要求

### Key Assumptions（关键假设）

**用户假设：**
- 用户具备基础命令行操作能力
- Windows 用户愿意使用 WSL

**技术假设：**
- VPN 网站页面结构相对稳定
- Playwright 不被反爬检测
- GitHub 可访问

**业务假设：**
- 动态订阅机场服务持续存在
- 有足够用户需求

---

## Risks & Open Questions（风险与待解决问题）

### Key Risks（核心风险）

1. **VPN 网站反爬机制 [高风险]**
   - 缓解：Playwright Stealth 模式，Cookie 登录

2. **网站页面结构变化 [中风险]**
   - 缓解：GitHub 远程选择器，快速更新

3. **Playwright 兼容性问题 [中风险]**
   - 缓解：详细文档，备选方案

4. **订阅地址验证误判 [低风险]**
   - 缓解：多重验证策略，强制更新选项

### Open Questions（待解决问题）

**技术问题：**
1. 验证码处理策略的优先级？
2. 订阅地址缓存时长？
3. 多账户并发更新？

**产品问题：**
1. 错误恢复策略？
2. 配置迁移方案？
3. 社区贡献机制？

---

## Appendices（附录）

### Appendix A: 技术选型对比

| 工具 | 速度 | JS支持 | Cookie管理 | 推荐度 |
|------|------|--------|------------|--------|
| Playwright | ⚡⚡⚡ 快 | ✅ | ✅ 优秀 | ⭐⭐⭐⭐⭐ |
| Selenium | ⚡⚡ 中等 | ✅ | ✅ 良好 | ⭐⭐⭐⭐ |
| MechanicalSoup | ⚡ 慢 | ❌ | ✅ | ❌ 不适合 |

### Appendix B: 命令速查表

| 命令 | 功能 |
|------|------|
| `autosub setup` | 配置向导 |
| `autosub update` | 更新订阅地址 |
| `autosub cron` | 设置定时更新 |
| `autosub upgrade` | 升级脚本 |
| `autosub status` | 查看状态 |

### Appendix C: 配置文件示例

```yaml
version: "1.0"
vpn_accounts:
  - name: "糖果云"
    website: "https://candytally.xyz/web/#/login"
    auth_method: "password"
    username: "encrypted:xxxxx"
    password: "encrypted:xxxxx"

clash_config:
  file_path: "/Users/xxx/.config/clash/config.yaml"
  backup_enabled: true
```

---

## Next Steps（下一步行动）

### Immediate Actions（立即行动）

1. ✅ **保存项目简报** - 已完成
2. 📋 **创建 PRD（产品需求文档）** - 进行中
3. 🏗️ **设计系统架构** - 待开始

### PM Handoff（移交给产品经理）

项目简报已完成，包含 Clash AutoSub（VPN 订阅地址自动化工具）的完整上下文。

**核心要点：**
- **问题：** 动态订阅地址（5 分钟更新）导致手动维护负担
- **解决方案：** Python + Playwright 自动化工具，支持双登录策略
- **目标用户：** 技术型 VPN 重度用户（macOS/Linux/Windows+WSL）
- **MVP 范围：** 配置向导 + 订阅更新 + Cron 定时 + 脚本自动更新
- **技术栈：** Python 3.9+ + Playwright + PyYAML + httpx

**请基于此简报创建 PRD，重点关注：**
1. 向导式配置流程的详细交互设计
2. 订阅地址验证逻辑的详细规则
3. 智能部分更新机制的边界条件
4. Cookie 管理和过期提醒的用户体验
5. 错误处理和回滚机制的完整流程

**参考配置文件：** `/Users/engtyleong/Projects/Clash AutoSub/yaml/clash_config_default.yaml`

---

**文档版本历史：**
- v1.0 (2025-10-01): 初始版本，完成项目简报
